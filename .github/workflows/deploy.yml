name: Deploy to 247 Server

on:
  push:
    branches:
      - main
    paths:
      - 'onecard-web/**'
      - 'onecard-api/**'

jobs:
  deploy:
    name: Deploy ${{ matrix.name }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - name: onecard-web
            path: onecard-web
            host_port: 8000
            container_port: 9413
            env_secret: ENV_FILE_WEB
          - name: onecard-api
            path: onecard-api
            host_port: 8001
            container_port: 8080
            env_secret: ENV_FILE_API
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup SSH Key
        run: |
          mkdir -p ./.ssh_keys
          echo "${{ secrets.SERVER_SSH_KEY }}" > ./.ssh_keys/id_rsa
          chmod 600 ./.ssh_keys/id_rsa

      - name: Create .env file from secrets
        run: |
          echo "${{ secrets[matrix.env_secret] }}" > ${{ matrix.path }}/.env

      - name: Copy .env file to remote
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key_path: ./.ssh_keys/id_rsa  # GITHUB_WORKSPACE 내의 상대 경로 사용
          source: ${{ matrix.path }}/.env
          target: "/home/${{ secrets.SERVER_USER }}/OSS-onecard/${{ matrix.path }}/"

      - name: Deploy to Remote Server
        run: |
          ssh -i ./.ssh_keys/id_rsa -o StrictHostKeyChecking=no ${{secrets.SERVER_USER}}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            
            cd /home/${{ secrets.SERVER_USER }}/OSS-onecard/${{ matrix.path }}
            git pull origin main --rebase
            
            echo "Building Docker Image for ${{ matrix.name }}..."
            docker build -t ${{ matrix.name }} .
            
            echo "Removing old container if exists..."
            docker stop ${{ matrix.name }} || true
            docker rm ${{ matrix.name }} || true
            
            echo "Running new container for ${{ matrix.name }}..."
            docker run -d \
              --name ${{ matrix.name }} \
              --network bridge \
              --env-file .env \
              -p ${{ matrix.host_port }}:${{ matrix.container_port }} \
              ${{ matrix.name }}
          EOF
